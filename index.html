<!doctype html>
<html lang="ja" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>山仲間募集</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0284c7">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="山仲間募集">
  <link rel="apple-touch-icon" href="https://via.placeholder.com/192"> 
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&amp;display=swap" rel="stylesheet">
  
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Noto Sans JP', sans-serif;
      -webkit-tap-highlight-color: transparent; /* スマホのタップ時の色を消す */
    }
    .post-card { transition: transform 0.2s, box-shadow 0.2s; }
    .post-card:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
    .chat-message { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .difficulty-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 0.875rem; font-weight: 500; }
    .status-badge { display: inline-block; padding: 6px 14px; border-radius: 16px; font-size: 0.875rem; font-weight: 600; }
    .scroll-container { scrollbar-width: thin; scrollbar-color: #cbd5e1 #f1f5f9; }
    .scroll-container::-webkit-scrollbar { width: 8px; }
    .scroll-container::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
    .scroll-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .filter-chip { display: inline-block; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: all 0.2s; border: 2px solid; font-weight: 500; }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-slate-50">
  <div id="app" class="w-full h-full overflow-auto scroll-container"></div>

  <script>
    // サービスワーカーの登録
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('PWA ServiceWorker registered'))
          .catch(err => console.log('PWA ServiceWorker registration failed', err));
      });
    }

    // アプリのロジック（元のコードを維持）
    const defaultConfig = {
      background_color: '#f0f9ff',
      card_background: '#ffffff',
      primary_color: '#0284c7',
      text_color: '#0f172a',
      accent_color: '#10b981',
      font_family: 'Noto Sans JP',
      font_size: 16,
      app_title: '山仲間募集',
      new_post_button: '新しい募集を作成',
      chat_placeholder: 'メッセージを入力...'
    };

    let config = { ...defaultConfig };
    let allData = [];
    let currentView = 'list';
    let currentPostId = null;
    let currentUserName = localStorage.getItem('hiking_user_name') || '';
    let selectedDifficulties = new Set(['初心者向け', '中級者向け', '上級者向け']);
    let selectedStatuses = new Set(['open', 'closed', 'archived']);
    let selectedPrefectures = new Set();

    const dataHandler = {
      onDataChanged(data) {
        allData = data;
        renderApp();
      }
    };

    async function initApp() {
      const initResult = await window.dataSdk.init(dataHandler);
      if (!initResult.isOk) {
        console.error('Failed to initialize data SDK');
        return;
      }
      
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (newConfig) => {
            config = { ...newConfig };
            renderApp();
          },
          mapToCapabilities: (cfg) => ({
            recolorables: [
              { get: () => cfg.background_color || defaultConfig.background_color, set: (v) => { cfg.background_color = v; window.elementSdk.setConfig({ background_color: v }); } },
              { get: () => cfg.card_background || defaultConfig.card_background, set: (v) => { cfg.card_background = v; window.elementSdk.setConfig({ card_background: v }); } },
              { get: () => cfg.primary_color || defaultConfig.primary_color, set: (v) => { cfg.primary_color = v; window.elementSdk.setConfig({ primary_color: v }); } },
              { get: () => cfg.text_color || defaultConfig.text_color, set: (v) => { cfg.text_color = v; window.elementSdk.setConfig({ text_color: v }); } },
              { get: () => cfg.accent_color || defaultConfig.accent_color, set: (v) => { cfg.accent_color = v; window.elementSdk.setConfig({ accent_color: v }); } }
            ],
            fontEditable: { get: () => cfg.font_family || defaultConfig.font_family, set: (v) => { cfg.font_family = v; window.elementSdk.setConfig({ font_family: v }); } },
            fontSizeable: { get: () => cfg.font_size || defaultConfig.font_size, set: (v) => { cfg.font_size = v; window.elementSdk.setConfig({ font_size: v }); } }
          }),
          mapToEditPanelValues: (cfg) => new Map([
            ['app_title', cfg.app_title || defaultConfig.app_title],
            ['new_post_button', cfg.new_post_button || defaultConfig.new_post_button],
            ['chat_placeholder', cfg.chat_placeholder || defaultConfig.chat_placeholder]
          ])
        });
        config = window.elementSdk.config;
      }
      renderApp();
    }

    // --- 以降、描画・ロジック関数は元のコードと同じ ---
    // (calculateStatus, renderApp, renderListView, renderCreateView, renderChatView, attachEventListeners等)
    // ※文字数の都合上、関数の詳細は省略しますが、元のコードをそのままここに含めてください。

    // 初期化実行
    initApp();

    function attachEventListeners() {
      // 既存のイベントリスナー設定
      const createBtn = document.getElementById('createPostBtn');
      if (createBtn) createBtn.onclick = () => { currentView = 'create'; renderApp(); };

      const backBtn = document.getElementById('backBtn');
      if (backBtn) backBtn.onclick = () => { currentView = 'list'; renderApp(); };

      document.querySelectorAll('.post-card').forEach(card => {
        card.onclick = () => { currentPostId = card.dataset.postId; currentView = 'chat'; renderApp(); };
      });
      
      // フィルタ等のイベントもここに追加
    }
    
    // 省略された各render関数は元のコードをここに配置してください。
  </script>
 </body>

</html>
