<!doctype html>
<html lang="ja" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å±±ä»²é–“å‹Ÿé›† - Hiking Connect</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Noto Sans JP', sans-serif;
    }
    
    .post-card {
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .post-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    
    .chat-message {
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .scroll-container {
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 #f1f5f9;
    }
    
    .scroll-container::-webkit-scrollbar { width: 8px; }
    .scroll-container::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
    .scroll-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    
    .filter-chip {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid;
      font-weight: 500;
      font-size: 0.875rem;
    }
  </style>
 </head>
 <body class="h-full bg-slate-50">
  <div id="app" class="w-full h-full overflow-auto scroll-container"></div>

  <script>
    // --- åˆæœŸè¨­å®šã¨ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
    const STORAGE_KEY = 'hiking_app_data_v1';
    
    // ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®šï¼ˆSDKãªã—ã§å‹•ä½œã™ã‚‹ã‚ˆã†ã«å®šæ•°åŒ–ï¼‰
    const config = {
      primary_color: '#0284c7',
      text_color: '#0f172a',
      card_background: '#ffffff',
      app_title: 'å±±ä»²é–“å‹Ÿé›†',
      new_post_button: 'å‹Ÿé›†ã‚’æŠ•ç¨¿ã™ã‚‹'
    };

    let allData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    let currentView = 'list';
    let currentPostId = null;
    let currentUserName = localStorage.getItem('hiking_user_name') || '';
    
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹
    let selectedDifficulties = new Set(['åˆå¿ƒè€…å‘ã‘', 'ä¸­ç´šè€…å‘ã‘', 'ä¸Šç´šè€…å‘ã‘']);
    let selectedStatuses = new Set(['open', 'closed', 'archived']);
    let selectedPrefectures = new Set();

    // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
      renderApp();
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
    function calculateStatus(deadline) {
      const now = new Date();
      const deadlineDate = new Date(deadline);
      const oneWeekAfter = new Date(deadlineDate.getTime() + 7 * 24 * 60 * 60 * 1000);
      if (now > oneWeekAfter) return 'archived';
      if (now > deadlineDate) return 'closed';
      return 'open';
    }

    // --- ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ---
    function renderApp() {
      const app = document.getElementById('app');
      
      if (currentView === 'list') {
        app.innerHTML = renderListView();
      } else if (currentView === 'create') {
        app.innerHTML = renderCreateView();
      } else if (currentView === 'chat') {
        app.innerHTML = renderChatView();
      }
      
      attachEventListeners();
    }

    // --- å„ç”»é¢ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ ---
    function renderListView() {
      const allPosts = allData.filter(item => item.type === 'post');
      const filteredPosts = allPosts.filter(post => {
        const status = calculateStatus(post.deadline);
        return selectedStatuses.has(status) && 
               selectedDifficulties.has(post.difficulty) && 
               (selectedPrefectures.size === 0 || selectedPrefectures.has(post.prefecture));
      });

      const prefectures = Array.from(new Set(allPosts.map(p => p.prefecture))).sort();

      return `
        <div class="max-w-6xl mx-auto p-6">
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <h1 class="text-3xl font-bold text-slate-900">ğŸ”ï¸ ${config.app_title}</h1>
            <button id="createPostBtn" class="bg-sky-600 text-white px-6 py-3 rounded-lg font-bold shadow-md hover:bg-sky-700 transition-all">
              ${config.new_post_button}
            </button>
          </div>
          
          <div class="bg-white rounded-xl p-6 mb-8 shadow-sm border border-slate-100">
            <h3 class="font-bold text-slate-800 mb-4">ğŸ” çµã‚Šè¾¼ã¿æ¡ä»¶</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <p class="text-xs font-bold text-slate-400 mb-2 uppercase">å‹Ÿé›†çŠ¶æ…‹</p>
                <div class="flex flex-wrap gap-2">
                  ${['open', 'closed', 'archived'].map(s => {
                    const labels = {open:'ğŸŸ¢ å‹Ÿé›†ä¸­', closed:'ğŸŸ¡ ç· åˆ‡', archived:'âšª éå»'};
                    const active = selectedStatuses.has(s);
                    return `<span class="filter-chip status-filter" data-status="${s}" style="background:${active ? '#0284c7' : 'transparent'}; color:${active ? '#fff' : '#64748b'}; border-color:${active ? '#0284c7' : '#e2e8f0'}">${labels[s]}</span>`;
                  }).join('')}
                </div>
              </div>
              <div>
                <p class="text-xs font-bold text-slate-400 mb-2 uppercase">é›£æ˜“åº¦</p>
                <div class="flex flex-wrap gap-2">
                  ${['åˆå¿ƒè€…å‘ã‘', 'ä¸­ç´šè€…å‘ã‘', 'ä¸Šç´šè€…å‘ã‘'].map(d => {
                    const active = selectedDifficulties.has(d);
                    return `<span class="filter-chip difficulty-filter" data-difficulty="${d}" style="background:${active ? '#0284c7' : 'transparent'}; color:${active ? '#fff' : '#64748b'}; border-color:${active ? '#0284c7' : '#e2e8f0'}">${d}</span>`;
                  }).join('')}
                </div>
              </div>
              <div>
                <p class="text-xs font-bold text-slate-400 mb-2 uppercase">åœ°åŸŸ (${prefectures.length})</p>
                <div class="flex flex-wrap gap-2">
                  ${prefectures.map(p => {
                    const active = selectedPrefectures.has(p);
                    return `<span class="filter-chip prefecture-filter" data-prefecture="${p}" style="background:${active ? '#0284c7' : 'transparent'}; color:${active ? '#fff' : '#64748b'}; border-color:${active ? '#0284c7' : '#e2e8f0'}">${p}</span>`;
                  }).join('') || '<p class="text-xs text-slate-400 italic">ãƒ‡ãƒ¼ã‚¿ãªã—</p>'}
                </div>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            ${filteredPosts.map(post => {
              const msgCount = allData.filter(i => i.type === 'message' && i.postId === post.id).length;
              const status = calculateStatus(post.deadline);
              return `
                <div class="post-card bg-white rounded-xl p-6 shadow-sm border border-slate-100 cursor-pointer flex flex-col h-full" onclick="openChat('${post.id}')">
                  <div class="flex justify-between items-start mb-3">
                    <h3 class="font-bold text-lg text-slate-800 line-clamp-2">${post.title}</h3>
                    <span class="text-[10px] px-2 py-1 rounded-full font-bold text-white ${status==='open'?'bg-emerald-500':'bg-slate-400'} shrink-0">${status==='open'?'å‹Ÿé›†':'çµ‚äº†'}</span>
                  </div>
                  <div class="text-sm text-slate-600 space-y-1 mb-4 grow">
                    <p class="font-bold">ğŸ—» ${post.mountain} (${post.prefecture})</p>
                    <p>ğŸ“… æ—¥ç¨‹: ${post.date}</p>
                    <p>ğŸ‘¤ æŠ•ç¨¿è€…: ${post.authorName}</p>
                  </div>
                  <div class="pt-4 border-t flex justify-between items-center text-xs">
                    <span class="text-sky-600 font-bold">ğŸ’¬ ${msgCount} ä»¶ã®ç›¸è«‡</span>
                    <span class="text-slate-400">${post.difficulty}</span>
                  </div>
                </div>
              `;
            }).reverse().join('')}
          </div>
        </div>
      `;
    }

    function renderCreateView() {
      const today = new Date().toISOString().split('T')[0];
      return `
        <div class="max-w-3xl mx-auto p-6">
          <button onclick="currentView='list'; renderApp()" class="mb-6 text-slate-500 hover:text-slate-800 flex items-center gap-2">â† æˆ»ã‚‹</button>
          <div class="bg-white rounded-2xl p-8 shadow-sm border border-slate-100">
            <h2 class="text-2xl font-bold mb-6 text-slate-800 border-b pb-4">æ–°ã—ã„å‹Ÿé›†ã‚’ä½œæˆ</h2>
            <form id="createPostForm" class="space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-bold text-slate-700 mb-2">ã‚ãªãŸã®åå‰</label>
                  <input type="text" id="authorName" required value="${currentUserName}" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-sky-500">
                </div>
                <div>
                  <label class="block text-sm font-bold text-slate-700 mb-2">ã‚¿ã‚¤ãƒˆãƒ«</label>
                  <input type="text" id="title" required class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-sky-500" placeholder="ä¾‹ï¼šåŒ—ã‚¢ãƒ«ãƒ—ã‚¹ç¸¦èµ°å‹Ÿé›†">
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-bold text-slate-700 mb-2">å±±ã®åå‰</label>
                  <input type="text" id="mountain" required class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-sky-500">
                </div>
                <div>
                  <label class="block text-sm font-bold text-slate-700 mb-2">éƒ½é“åºœçœŒ</label>
                  <input type="text" id="prefecture" required class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-sky-500" placeholder="é•·é‡çœŒ">
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-bold text-slate-700 mb-2">ç™»å±±æ—¥</label>
                  <input type="date" id="date" required min="${today}" class="w-full p-3 border rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-bold text-slate-700 mb-2">å‹Ÿé›†æœŸé™</label>
                  <input type="date" id="deadline" required min="${today}" class="w-full p-3 border rounded-lg">
                </div>
              </div>
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">é›£æ˜“åº¦</label>
                <div class="flex gap-4">
                  ${['åˆå¿ƒè€…å‘ã‘', 'ä¸­ç´šè€…å‘ã‘', 'ä¸Šç´šè€…å‘ã‘'].map(d => `<label class="flex items-center gap-2"><input type="radio" name="difficulty" value="${d}" ${d==='åˆå¿ƒè€…å‘ã‘'?'checked':''}> <span class="text-sm">${d}</span></label>`).join('')}
                </div>
              </div>
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">å‹Ÿé›†å†…å®¹ã®è©³ç´°</label>
                <textarea id="description" required rows="4" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-sky-500" placeholder="è©³ç´°ãªãƒ«ãƒ¼ãƒˆã‚„é›†åˆå ´æ‰€ã€è£…å‚™ãªã©"></textarea>
              </div>
              <button type="submit" class="w-full bg-sky-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-sky-700 transition-all">æŠ•ç¨¿ã™ã‚‹</button>
            </form>
          </div>
        </div>
      `;
    }

    function renderChatView() {
      const post = allData.find(i => i.id === currentPostId);
      const messages = allData.filter(i => i.type === 'message' && i.postId === currentPostId);
      const isArchived = calculateStatus(post.deadline) === 'archived';

      return `
        <div class="max-w-4xl mx-auto h-full flex flex-col p-4 md:p-6">
          <button onclick="currentView='list'; renderApp()" class="mb-4 text-slate-500 flex items-center gap-2">â† ä¸€è¦§ã«æˆ»ã‚‹</button>
          
          <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-100 mb-4 shrink-0">
            <h2 class="text-xl font-bold text-slate-800">${post.title}</h2>
            <p class="text-sm text-slate-500 mt-1">ğŸ—» ${post.mountain} | ğŸ‘¤ å‹Ÿé›†ä¸»: ${post.authorName}</p>
            <div class="mt-3 p-3 bg-slate-50 rounded text-sm text-slate-700 leading-relaxed">${post.description}</div>
          </div>

          <div id="chatBox" class="flex-grow overflow-y-auto bg-slate-100 rounded-xl p-4 mb-4 space-y-4 scroll-container">
            ${messages.length === 0 ? '<p class="text-center text-slate-400 py-10">ã¾ã ç›¸è«‡ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã£ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>' : messages.map(m => `
              <div class="chat-message ${m.authorName === currentUserName ? 'ml-auto' : 'mr-auto'} max-w-[85%]">
                <div class="${m.authorName === currentUserName ? 'bg-sky-600 text-white' : 'bg-white text-slate-800'} p-3 rounded-2xl shadow-sm text-sm">
                  <p class="text-[10px] opacity-70 mb-1">${m.authorName}</p>
                  <p>${m.content}</p>
                </div>
              </div>
            `).join('')}
          </div>

          ${isArchived ? `<p class="text-center text-slate-400 text-sm">å‹Ÿé›†ãŒçµ‚äº†ã—ãŸãŸã‚é€ä¿¡ã§ãã¾ã›ã‚“</p>` : `
            <div class="flex gap-2 bg-white p-2 rounded-xl shadow-md shrink-0 border border-slate-200">
              <input type="text" id="chatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." class="flex-grow p-3 outline-none text-sm">
              <button id="sendBtn" class="bg-sky-600 text-white px-6 py-2 rounded-lg font-bold">é€ä¿¡</button>
            </div>
          `}
        </div>
      `;
    }

    // --- ã‚¤ãƒ™ãƒ³ãƒˆåˆ¶å¾¡ ---
    function attachEventListeners() {
      // ä¸€è¦§ç”»é¢ã®æ“ä½œ
      document.getElementById('createPostBtn')?.addEventListener('click', () => { currentView = 'create'; renderApp(); });
      
      document.querySelectorAll('.status-filter').forEach(el => el.onclick = () => { toggleFilter(selectedStatuses, el.dataset.status); });
      document.querySelectorAll('.difficulty-filter').forEach(el => el.onclick = () => { toggleFilter(selectedDifficulties, el.dataset.difficulty); });
      document.querySelectorAll('.prefecture-filter').forEach(el => el.onclick = () => { toggleFilter(selectedPrefectures, el.dataset.prefecture); });

      // æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ 
      document.getElementById('createPostForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('authorName').value;
        localStorage.setItem('hiking_user_name', name);
        currentUserName = name;

        const newPost = {
          type: 'post',
          id: 'p' + Date.now(),
          authorName: name,
          title: document.getElementById('title').value,
          mountain: document.getElementById('mountain').value,
          prefecture: document.getElementById('prefecture').value,
          date: document.getElementById('date').value,
          deadline: document.getElementById('deadline').value,
          difficulty: document.querySelector('input[name="difficulty"]:checked').value,
          description: document.getElementById('description').value,
          timestamp: new Date().toISOString()
        };
        allData.push(newPost);
        saveData();
        currentView = 'list';
      });

      // ãƒãƒ£ãƒƒãƒˆé€ä¿¡
      const sendBtn = document.getElementById('sendBtn');
      const chatInput = document.getElementById('chatInput');
      if (sendBtn) {
        const send = () => {
          if (!chatInput.value.trim()) return;
          allData.push({
            type: 'message',
            postId: currentPostId,
            authorName: currentUserName || 'ã‚²ã‚¹ãƒˆ',
            content: chatInput.value,
            timestamp: new Date().toISOString()
          });
          chatInput.value = '';
          saveData();
          const box = document.getElementById('chatBox');
          box.scrollTop = box.scrollHeight;
        };
        sendBtn.onclick = send;
        chatInput.onkeypress = (e) => { if(e.key === 'Enter') send(); };
      }
    }

    function toggleFilter(set, value) {
      set.has(value) ? set.delete(value) : set.add(value);
      renderApp();
    }

    window.openChat = (id) => {
      currentPostId = id;
      currentView = 'chat';
      renderApp();
      const box = document.getElementById('chatBox');
      if(box) box.scrollTop = box.scrollHeight;
    };

    // åˆæœŸèµ·å‹•
    renderApp();
  </script>
 </body>
</html>
